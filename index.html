<!DOCTYPE html>
<html>
<head>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<script src="https://code.highcharts.com/highcharts.js"></script>
<script src="https://code.highcharts.com/modules/exporting.js"></script>

<div id="container" style="min-width: 300px; height: 400px; margin: 0 auto"></div>
<script>
  var url = 'https://data.marincounty.org/resource/mw3d-ud6d.json';
  let chartInfo = {};

  $.ajax({
          url: url,
          type: 'GET',
          dataType: "json",
          success: function (json) {
      /* get json data */
      $(jQuery.parseJSON(JSON.stringify(json))).each(function() {

      let data = {};
      let start = new Date("06-01-2016");
      let end = new Date("06-01-2017");

      while(start < end){
          var newDate = start.setMonth(start.getMonth() + 1);
          start = new Date(newDate);
          data[start.toJSON().slice(0,7)] = {};
      }
      /* iterate through all json objects and get the necesarry data */
      for (let i = 0; i < json.length; i++) {
        /* substract the date from the json value "2016-07-01T00:00:00.000" format
        * and store it in monthYear variable;
        */
        let monthYear = json[i].month_and_year.substring(0, 7);
        /*
        *
        *
        */
        if (json[i].department in data[monthYear]) {
          data[monthYear][json[i].department] += parseInt(json[i].amount);
        }
        else {
          data[monthYear][json[i].department] = parseInt(json[i].amount);
        }
      }

      for (let elem in data) {
        let new_value = [];
        for (let key in data[elem]) {
          new_value.push([ key, data[elem][key] ]);
          }
        chartInfo[elem] = new_value;
        }
      });
    }
  });

  // http://api.highcharts.com/highcharts/xAxis.labels.format
  function loadBarChart(){
    let picker = document.getElementById('picker').value;
    Highcharts.chart('container', {
      chart: {
        type: 'column',
        backgroundColor: '#FFFAFA',
      },
        title: {
        text: 'Bouquet.ai Exercise'
      },
        subtitle: {
        text: 'Contract amounts in Marin Country by department'
      },
        xAxis: {
        type: 'category',
        labels: {
        rotation: -45,
        style: {
        fontSize: '11px',
        fontFamily: 'Verdana, sans-serif'
          }
        }
      },
        yAxis: {
        min: 0,
        title: {
          text: 'Total amount ($)'
        },
      },
        legend: {
        enabled: false
      },
        tooltip: {
        pointFormat: 'Total sum amount by department: <b>{point.y:,.0f}k</b>'
      },
        series: [{
        name: 'Total amount',
        data: chartInfo[picker],
        dataLabels: {
          enabled: true,
          rotation: -90,
          color: '#FFFFFF',
          align: 'right',
          format: '{point.y:,.0f}', // one decimal
          y: 10, // 10 pixels down from the top
          style: {
          fontSize: '8px',
          fontFamily: 'Verdana, sans-serif',
          }
        }
      }]
    });
  }
</script>

</head>
<body>
  <input type="month" id="picker" value='2016-07' min='2016-07' max='2017-06' onchange='loadBarChart()'>
</body>
</html>
